name: FTP Deploy (Published Code)

on:
  push:
    branches:
      - master  # Sadece master branch'e push yapıldığında çalışır

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Kodu GitHub'dan Çek
      - name: Kodu GitHub'dan Çek
        uses: actions/checkout@v2

      # .NET SDK Kurulumu
      - name: .NET SDK Kurulumu
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'  # Kullanılan .NET sürümüne göre değiştirebilirsin

      # Projeyi Build ve Publish Et
      - name: Projeyi Build ve Publish Et
        run: dotnet publish ./MyBlogSite.Consumers/MailConsumer/MailConsumer.csproj -c Release -o ./publish

      # Web.config içinde ASPNETCORE_ENVIRONMENT Değişkenini Güncelle
      - name: Web.config İçine ASPNETCORE_ENVIRONMENT Ekle
        run: |
          if [ -f "./publish/web.config" ]; then
            sed -i 's|</aspNetCore>|<environmentVariables><environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" /></environmentVariables></aspNetCore>|' ./publish/web.config
          fi

      # Publish Edilen Kodları FTP'ye Yükle
      - name: FTP ile Publish Edilen Kodları Yükle
        uses: SamKirkland/FTP-Deploy-Action@4.3.1
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./publish/  # Sadece publish edilen kodları yükle
          server-dir: /httpdocs/  # FTP sunucusundaki hedef klasör
